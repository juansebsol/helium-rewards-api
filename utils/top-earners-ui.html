<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Helium Rewards API - Top Earners</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7f9;
        --panel: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --soft: #f3f4f6;
        --primary: #16a34a;
        --radius: 12px;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
        background: var(--bg);
        color: var(--text);
        padding: 16px;
      }

      .container {
        max-width: 980px;
        margin: 0 auto;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }

      .header {
        padding: 16px 18px;
        border-bottom: 1px solid var(--border);
      }
      .header h1 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }
      .header p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }

      .content {
        padding: 18px;
      }

      .section {
        margin-bottom: 18px;
      }
      .section:last-child {
        margin-bottom: 0;
      }
      .section h2 {
        margin: 0 0 10px;
        font-size: 13px;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: var(--muted);
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
      }
      input,
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 14px;
        background: white;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: rgba(37, 99, 235, 0.7);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: end;
      }
      .field {
        flex: 1;
        min-width: 220px;
      }
      .button {
        appearance: none;
        border: 1px solid rgba(0, 0, 0, 0);
        background: var(--primary);
        color: white;
        font-weight: 600;
        font-size: 13px;
        padding: 9px 12px;
        border-radius: 10px;
        cursor: pointer;
        height: 40px;
      }
      .button.secondary {
        background: var(--soft);
        color: var(--text);
        border-color: var(--border);
      }
      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .switcher {
        display: flex;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: var(--soft);
        margin-bottom: 10px;
      }
      .switcher button {
        flex: 1;
        border: none;
        background: transparent;
        padding: 10px 12px;
        font-weight: 700;
        font-size: 13px;
        color: var(--muted);
        cursor: pointer;
      }
      .switcher button.active {
        background: white;
        color: var(--text);
      }

      .result {
        display: none;
        margin-top: 12px;
        border-radius: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: white;
        font-size: 13px;
      }
      .result.error {
        border-color: rgba(220, 38, 38, 0.35);
        background: rgba(220, 38, 38, 0.08);
      }

      .meta {
        font-size: 12px;
        color: var(--muted);
        margin: 8px 0 0;
      }

      .chart {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: white;
        overflow: hidden;
      }
      .chart-header {
        display: grid;
        grid-template-columns: 44px 1fr 140px 120px;
        gap: 10px;
        padding: 10px 12px;
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        background: var(--soft);
        border-bottom: 1px solid var(--border);
      }
      .bar-row {
        display: grid;
        grid-template-columns: 44px 1fr 140px 120px;
        gap: 10px;
        padding: 10px 12px;
        align-items: center;
        border-top: 1px solid var(--border);
      }
      .bar-row:first-child {
        border-top: none;
      }
      .rank {
        font-size: 12px;
        color: var(--muted);
        font-weight: 700;
        text-align: right;
        padding-right: 6px;
      }
      .device {
        min-width: 0;
      }
      .device .key {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(22, 163, 74, 0.18);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(22, 163, 74, 0.22);
      }
      .bar > span {
        position: absolute;
        inset: 0;
        width: 0%;
        background: rgba(22, 163, 74, 0.75);
      }
      .num {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        text-align: right;
      }

      @media (max-width: 840px) {
        .chart-header,
        .bar-row {
          grid-template-columns: 44px 1fr 120px;
        }
        .bar-col {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Helium Rewards API</h1>
        <p>Top earners (DC) debug UI</p>
      </div>

      <div class="content">
        <div class="section">
          <h2>API Configuration</h2>
          <div class="row">
            <div class="field">
              <label for="apiUrl">API Base URL</label>
              <input
                id="apiUrl"
                type="url"
                value="https://helium-rewards-api.vercel.app"
              />
            </div>
            <div class="field" style="max-width: 160px">
              <label for="limit">Limit</label>
              <select id="limit">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
              </select>
            </div>
            <button class="button" id="refreshBtn">Refresh</button>
            <button class="button secondary" id="copyBtn" title="Copy JSON response">
              Copy JSON
            </button>
          </div>
          <div class="meta" id="meta"></div>
          <div class="result error" id="error"></div>
        </div>

        <div class="section">
          <h2>Window</h2>
          <div class="switcher">
            <button type="button" data-window="1" class="active">1 day</button>
            <button type="button" data-window="7">7 days</button>
            <button type="button" data-window="30">30 days</button>
          </div>

          <div class="chart">
            <div class="chart-header">
              <div>Rank</div>
              <div>Device key</div>
              <div class="bar-col">Chart</div>
              <div style="text-align: right">Total HNT</div>
            </div>
            <div id="rows"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentWindow = "1";
      let lastJson = null;

      function getApiUrl() {
        return document.getElementById("apiUrl").value.replace(/\/$/, "");
      }

      function setError(html) {
        const el = document.getElementById("error");
        if (!html) {
          el.style.display = "none";
          el.innerHTML = "";
          return;
        }
        el.style.display = "block";
        el.innerHTML = html;
      }

      function setMeta(text) {
        document.getElementById("meta").textContent = text || "";
      }

      function fmt(n) {
        if (n == null) return "0";
        const x = Number(n);
        if (Number.isNaN(x)) return String(n);
        return x.toLocaleString(undefined, { maximumFractionDigits: 2 });
      }

      function escapeHtml(s) {
        const div = document.createElement("div");
        div.textContent = String(s ?? "");
        return div.innerHTML;
      }

      function render(windowDays, list) {
        const rows = document.getElementById("rows");
        const max = Math.max(1, ...list.map((x) => Number(x.total_hnt || 0)));

        rows.innerHTML = list
          .map((x) => {
            const pct = Math.max(0, Math.min(100, (Number(x.total_hnt || 0) / max) * 100));
            const key = String(x.device_key || "");
            return `
              <div class="bar-row">
                <div class="rank">${x.rank}</div>
                <div class="device" title="${escapeHtml(key)}">
                  <div class="key">${escapeHtml(key)}</div>
                </div>
                <div class="bar bar-col" aria-hidden="true"><span style="width:${pct.toFixed(2)}%"></span></div>
                <div class="num">${fmt(x.total_hnt)}</div>
              </div>
            `;
          })
          .join("");

        if (!list.length) {
          rows.innerHTML = `<div class="bar-row"><div class="rank">-</div><div class="device"><div class="key">No data</div></div><div class="bar bar-col"></div><div class="num">0</div></div>`;
        }
      }

      async function load() {
        const limit = document.getElementById("limit").value;
        const url = `${getApiUrl()}/api/top-earners?window_days=${encodeURIComponent(
          currentWindow
        )}&limit=${encodeURIComponent(limit)}`;

        const refreshBtn = document.getElementById("refreshBtn");
        refreshBtn.disabled = true;
        setError("");

        try {
          const res = await fetch(url, { headers: { Accept: "application/json" } });
          const text = await res.text();
          let json;
          try {
            json = JSON.parse(text);
          } catch (_) {
            throw new Error(`Non-JSON response (HTTP ${res.status})`);
          }
          if (!res.ok || !json.success) {
            throw new Error(json.error || `HTTP ${res.status}`);
          }

          lastJson = json;
          const list = (json.results && json.results[currentWindow]) || [];
          render(currentWindow, list);

          const snap = json.snapshot || {};
          setMeta(
            `Snapshot: ${snap.created_at || "unknown"} | Prefix: ${snap.source_prefix || "unknown"} | Window: ${currentWindow} day(s)`
          );
        } catch (e) {
          setError(
            `<strong>Failed to load top earners</strong><br>${escapeHtml(
              e?.message || "Request failed"
            )}<br><br><code>${escapeHtml(url)}</code>`
          );
          document.getElementById("rows").innerHTML = "";
          setMeta("");
        } finally {
          refreshBtn.disabled = false;
        }
      }

      function setWindow(w) {
        currentWindow = String(w);
        document.querySelectorAll(".switcher button").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.window === currentWindow);
        });
        load();
      }

      async function copyJson() {
        if (!lastJson) return;
        const text = JSON.stringify(lastJson, null, 2);
        try {
          await navigator.clipboard.writeText(text);
        } catch (_) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
      }

      document.getElementById("refreshBtn").addEventListener("click", load);
      document.getElementById("copyBtn").addEventListener("click", copyJson);
      document.getElementById("limit").addEventListener("change", load);
      document.querySelectorAll(".switcher button").forEach((btn) => {
        btn.addEventListener("click", () => setWindow(btn.dataset.window));
      });

      window.addEventListener("load", () => {
        setWindow("1");
      });
    </script>
  </body>
</html>

